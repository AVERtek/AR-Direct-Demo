<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugarlump Amazon Book - AR First, Sync Audio & Animation</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            position: relative;
            overflow: hidden;
        }
        model-viewer {
            width: 100%;
            height: 100vh;
            background-color: #ffffff;
        }

        /* Container for the main controls (Play/Pause, Go to Book) */
        .main-controls-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 10;
        }

        /* Styling for all buttons */
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        /* Specific styles for each button type */
        .ar-button {
            background-color: #007bff; /* Blue for AR */
            color: white;
        }
        .ar-button:hover {
            background-color: #0056b3;
        }

        .play-pause-button {
            background-color: #6f42c1; /* Purple for Play/Pause */
            color: white;
        }
        .play-pause-button:hover {
            background-color: #5a2e9b;
        }

        .url-button {
            background-color: #28a745; /* Green for URL */
            color: white;
        }
        .url-button:hover {
            background-color: #218838;
        }

        /* Message for PC users for AR */
        #ar-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            z-index: 20; /* Ensure it's above everything */
            display: none; /* Hidden by default */
        }

        /* Message for Audio Autoplay Failure */
        #audio-fallback-message {
            position: absolute;
            top: 20%; /* Position higher up */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 99, 71, 0.9); /* Tomato red */
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            text-align: center;
            font-size: 1em;
            z-index: 30; /* Above AR message */
            display: none; /* Hidden by default */
            cursor: pointer; /* Indicate it's clickable */
        }
    </style>
</head>
<body>
    <div id="ar-message">
        This AR experience requires a mobile device.<br>
        Please open this page on your smartphone or tablet.
        <br><br>
        (The 3D model will appear below, but AR features are mobile-only.)
    </div>

    <div id="audio-fallback-message">
        Tap here to enable sound.
    </div>

    <model-viewer
        id="myModelViewer"
        src="Models/kindness_rocks_large_7.glb"
        ios-src="KINDNESS_ROCKS_LARGE_7_Output.usdz"
        alt="A 3D model"
        ar
        ar-modes="scene-viewer webxr quick-look"
        camera-controls
        poster="images/rocks.png"
        shadow-intensity="1"
        ar-scale="auto"
        ar-placement="floor"
        interaction-prompt="none"
        animation-name="Wave" autoplay="false" >
        <button slot="ar-button" id="ar-button" class="ar-button">Launch AR</button>
    </model-viewer>

    <audio id="audio" src="Sound/Kindness Rocks_mix.mp3" loop></audio>

    <div class="main-controls-container">
        <button id="playPauseButton" class="play-pause-button">Play Animation & Audio</button>
        <button id="url-button" class="url-button">Go to Book</button>
    </div>

    <script>
        const modelViewer = document.getElementById('myModelViewer');
        const playPauseButton = document.getElementById('playPauseButton');
        const urlButton = document.getElementById('url-button');
        const audio = document.getElementById('audio');
        const arMessage = document.getElementById('ar-message');
        const arButton = document.getElementById('ar-button'); // Reference to the slotted AR button
        const audioFallbackMessage = document.getElementById('audio-fallback-message');

        let isPlaying = false; // Initial state: neither animation nor audio is playing

        // --- Device Detection (Simple) ---
        function isMobileDevice() {
            return /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   ('ontouchstart' in window && navigator.maxTouchPoints > 0);
        }

        // --- Unified Play/Pause Function for Model Animation and Audio ---
        function togglePlayPause() {
            if (isPlaying) {
                modelViewer.pause();
                audio.pause();
                playPauseButton.textContent = 'Play Animation & Audio';
            } else {
                modelViewer.play();
                audio.play().catch(error => {
                    console.warn("Audio play failed on Play/Pause button click:", error);
                    // If play fails here, it's likely a browser restriction.
                    // The fallback message will handle it if it appears.
                });
                playPauseButton.textContent = 'Pause Animation & Audio';
            }
            isPlaying = !isPlaying;
        }

        // --- Function to play audio with fallback message ---
        function playAudioWithFallback() {
            audio.play().then(() => {
                // Audio played successfully, hide fallback message
                audioFallbackMessage.style.display = 'none';
            }).catch(error => {
                console.error("Audio play failed, showing fallback:", error);
                // Show fallback message if audio autoplay is blocked
                audioFallbackMessage.style.display = 'block';
                audioFallbackMessage.onclick = () => {
                    audio.play().then(() => {
                        audioFallbackMessage.style.display = 'none';
                    }).catch(err => {
                        console.error("Audio still failing after user tap:", err);
                    });
                };
            });
        }


        // --- Initial Setup and Immediate AR Launch on Mobile / PC Message ---
        document.addEventListener('DOMContentLoaded', () => {
            if (isMobileDevice()) {
                arMessage.style.display = 'none'; // Hide generic PC message on mobile
                // Attempt to launch AR immediately on mobile.
                // Note: activateAR() might still require a user gesture for actual session start.
                modelViewer.activateAR();
            } else {
                // On PC, show the message and hide the AR button as it's not functional
                arMessage.style.display = 'block';
                arButton.style.display = 'none'; // Hide the AR button on desktop
            }

            // Set initial play/pause button state
            playPauseButton.textContent = 'Play Animation & Audio';
        });

        // --- Event Listeners for Model Viewer and Controls ---

        // Main Play/Pause button click
        playPauseButton.addEventListener('click', togglePlayPause);

        // Listen for model-viewer's internal play/pause events
        // These are to keep our button and state in sync if animation
        // state changes occur outside our button (e.g., when AR starts/ends)
        modelViewer.addEventListener('play', () => {
            // Only update if our button wasn't the direct cause of this 'play' event
            if (!isPlaying) {
                isPlaying = true;
                playPauseButton.textContent = 'Pause Animation & Audio';
                if (audio.paused) { // Ensure audio also plays
                    audio.play().catch(error => console.warn("Audio play failed on model.play event:", error));
                }
            }
        });

        modelViewer.addEventListener('pause', () => {
            // Only update if our button wasn't the direct cause of this 'pause' event
            if (isPlaying) {
                isPlaying = false;
                playPauseButton.textContent = 'Play Animation & Audio';
                if (!audio.paused) { // Ensure audio also pauses
                    audio.pause();
                }
            }
        });

        // --- Crucial: Play animation and audio when AR session starts ---
        modelViewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'session-started') {
                console.log('AR session started! Attempting to play animation and audio.');
                // Hide main controls and message during AR session for immersive experience
                playPauseButton.style.display = 'none';
                urlButton.style.display = 'block'; // Show URL button in AR
                arMessage.style.display = 'none'; // Ensure message is hidden
                audioFallbackMessage.style.display = 'none'; // Hide audio message too

                // Immediately play animation and audio upon AR session start
                modelViewer.play();
                playAudioWithFallback(); // Use our robust audio play function

                isPlaying = true; // Update global state
                // (playPauseButton text is not visible in AR, but kept updated for consistency)

            } else if (event.detail.status === 'session-ended') {
                console.log('AR session ended.');
                // Show main controls again after AR session ends
                playPauseButton.style.display = 'block';
                urlButton.style.display = 'none'; // Hide URL button again
                modelViewer.pause(); // Pause animation when leaving AR
                audio.pause();       // Pause audio when leaving AR
                isPlaying = false;
                playPauseButton.textContent = 'Play Animation & Audio';
                audioFallbackMessage.style.display = 'none'; // Hide any lingering audio message

                // If on PC, re-show the AR message
                if (!isMobileDevice()) {
                    arMessage.style.display = 'block';
                    arButton.style.display = 'none';
                }
            } else if (event.detail.status === 'not-ar-capable') {
                // This status can occur on mobile if device truly isn't AR capable,
                // or on desktop if the model-viewer determines it.
                if (!isMobileDevice()) { // Only show message if definitely on PC
                    arMessage.style.display = 'block';
                    arButton.style.display = 'none';
                }
            }
            // For other ar-status like 'failed', 'error', etc., you might add more handling
        });

        // --- URL Button Logic ---
        urlButton.addEventListener('click', () => {
            const amazonUrl = "https://www.amazon.com/Sweet-Dreams-Sugarlump-childrens-everywhere/dp/B0FFZD7D12/ref=sr_1_1?crid=2PE5ZR31RUKFJ&dib=eyJ2IjoiMSJ9.eirXTPVo6volOV0M2LSzWYM7M7OETpDHtuB5kCsvMqZpHjvNE3fvrGYiQzi9OEE_KnGVoDwiK8TJUKsihTlWlEkYrzfe4QfSs8rE6vaoo0Y5BfWqKzpuFPGm7bKE9IC-Kz-0FvP462KBgxOa04D1aqfLppMInjk90QDppqNon6eTrQ0InDpeNmty3hB14QayZjes0oEcHGgvSH_4mtoM9SHyIbK9wzspljEyRdN_vAiF9SAFTutLx3FZqHy8JM44s5QDZ0XdYakBff_dMR3KMvFf10ZCsMFhMmGz6QY5jPI.EkEaYpKKTbUyJ3uJZG_vjHaGCtcX2MSHyN27dyNdIqY&dib_tag=se&keywords=sugarlump&qid=1752536576&sprefix=sugarlump%2Caps%2C158&sr=8-1'";
            window.open(amazonUrl, '_blank');
        });

    </script>
</body>
</html>



<!--<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sugarlump Amazon Book</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
  <style>
    #ar-button {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #url-button {
      display: none;
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <model-viewer 
    src="Models/kindness_rocks_large_7.glb?sound=Sound/Kindness Rocks_mix.mp3" 
    ios-src="KINDNESS_ROCKS_LARGE_7_Output.usdz"
    alt="A 3D model" 
    ar 
    ar-modes="scene-viewer webxr quick-look" 
    camera-controls 
    auto-rotate 
    autoplay 
    poster="images/rocks.png" 
    shadow-intensity="1" 
    ar-scale="auto" 
    ar-placement="floor"
    interaction-prompt="none">
    <button slot="ar-button" id="ar-button">View in your space</button>
  </model-viewer>

  <audio id="audio" src="Sound/Kindness Rocks_mix.mp3" loop></audio>
  <button id="play-audio" onclick="document.getElementById('audio').play()">Play Audio</button>

  <button id="url-button" onclick="window.location.href='https://www.amazon.com/Sweet-Dreams-Sugarlump-childrens-everywhere/dp/B0FFZD7D12/ref=sr_1_1?crid=2PE5ZR31RUKFJ&dib=eyJ2IjoiMSJ9.eirXTPVo6volOV0M2LSzWYM7M7OETpDHtuB5kCsvMqZpHjvNE3fvrGYiQzi9OEE_KnGVoDwiK8TJUKsihTlWlEkYrzfe4QfSs8rE6vaoo0Y5BfWqKzpuFPGm7bKE9IC-Kz-0FvP462KBgxOa04D1aqfLppMInjk90QDppqNon6eTrQ0InDpeNmty3hB14QayZjes0oEcHGgvSH_4mtoM9SHyIbK9wzspljEyRdN_vAiF9SAFTutLx3FZqHy8JM44s5QDZ0XdYakBff_dMR3KMvFf10ZCsMFhMmGz6QY5jPI.EkEaYpKKTbUyJ3uJZG_vjHaGCtcX2MSHyN27dyNdIqY&dib_tag=se&keywords=sugarlump&qid=1752536576&sprefix=sugarlump%2Caps%2C158&sr=8-1'">Go to Book</button>

  <script>
    const modelViewer = document.querySelector('model-viewer');
    modelViewer.addEventListener('ar-status', (event) => {
      if (event.detail.status === 'session-started') {
        document.getElementById('url-button').style.display = 'block';
      } else {
        document.getElementById('url-button').style.display = 'none';
      }
    });
  </script>
</body>
</html> -->

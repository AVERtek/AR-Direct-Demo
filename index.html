<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugarlump Amazon Book - Robust AR Audio & Animation Sync</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            position: relative;
            overflow: hidden;
        }
        model-viewer {
            width: 100%;
            height: 100vh;
            background-color: #ffffff;
        }

        /* Container for the main controls (Play/Pause, Go to Book) */
        .main-controls-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 10;
        }

        /* Styling for all buttons */
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        /* Specific styles for each button type */
        .ar-button {
            background-color: #007bff; /* Blue for AR */
            color: white;
        }
        .ar-button:hover {
            background-color: #0056b3;
        }

        .play-pause-button {
            background-color: #6f42c1; /* Purple for Play/Pause */
            color: white;
        }
        .play-pause-button:hover {
            background-color: #5a2e9b;
        }

        .url-button {
            background-color: #28a745; /* Green for URL */
            color: white;
        }
        .url-button:hover {
            background-color: #218838;
        }

        /* Message for PC users for AR */
        #ar-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2em;
            z-index: 20; /* Ensure it's above everything */
            display: none; /* Hidden by default */
        }

        /* Prompt for audio in AR if it doesn't autoplay */
        #audio-in-ar-prompt {
            position: absolute;
            top: 10%; /* Position near the top for visibility in AR */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 99, 71, 0.9); /* Tomato red */
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            text-align: center;
            font-size: 1em;
            z-index: 30; /* Above all other elements */
            display: none; /* Hidden by default */
            cursor: pointer; /* Indicate it's clickable */
            white-space: nowrap; /* Prevent text wrapping */
            animation: pulse 1.5s infinite; /* Added a subtle animation */
        }

        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) scale(1.03); opacity: 0.9; }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="ar-message">
        This AR experience requires a mobile device.<br>
        Please open this page on your smartphone or tablet.
        <br><br>
        (The 3D model will appear below, but AR features are mobile-only.)
    </div>

    <div id="audio-in-ar-prompt">
        Tap to Enable Sound
    </div>

    <model-viewer
        id="myModelViewer"
        src="Models/kindness_rocks_large_7.glb?sound=Sound/Kindness Rocks_mix.mp3"
        ios-src="KINDNESS_ROCKS_LARGE_7_Output.usdz"
        alt="A 3D model"
        ar
        ar-modes="scene-viewer webxr quick-look"
        camera-controls
        poster="images/rocks.png"
        shadow-intensity="1"
        ar-scale="auto"
        ar-placement="floor"
        interaction-prompt="none"
        animation-name="Wave" autoplay="false" >
        <button slot="ar-button" id="ar-button" class="ar-button">Launch AR</button>
    </model-viewer>

    <audio id="audio" src="Sound/Kindness Rocks_mix.mp3" loop></audio>

    <div class="main-controls-container">
        <button id="playPauseButton" class="play-pause-button">Play Animation & Audio</button>
        <button id="url-button" class="url-button">Go to Book</button>
    </div>

    <script>
        const modelViewer = document.getElementById('myModelViewer');
        const playPauseButton = document.getElementById('playPauseButton');
        const urlButton = document.getElementById('url-button');
        const audio = document.getElementById('audio');
        const arMessage = document.getElementById('ar-message');
        const arButton = document.getElementById('ar-button'); // Reference to the slotted AR button
        const audioInARPrompt = document.getElementById('audio-in-ar-prompt'); // Audio prompt for AR

        let isPlaying = false; // Initial state for desktop animation/audio
        let isARActive = false; // Flag to track if AR session is active
        let audioAlreadyPlayedInAR = false; // New flag to prevent prompt reappearing once tapped

        // --- Device Detection (Simple) ---
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   ('ontouchstart' in window && navigator.maxTouchPoints > 0);
        }

        // --- Unified Play/Pause Function for Model Animation and Audio (Desktop/Viewer Mode) ---
        function togglePlayPause() {
            // Only allow this button to function if AR is NOT active
            if (isARActive) {
                console.log("Play/Pause button ignored, AR is active.");
                return;
            }

            if (isPlaying) {
                modelViewer.pause();
                audio.pause();
                playPauseButton.textContent = 'Play Animation & Audio';
            } else {
                // Only try to play animation if an animation name is set
                if (modelViewer.animationName) {
                    modelViewer.play();
                } else {
                    console.warn("No animation-name specified or found on model. Cannot play animation.");
                }

                // Attempt to play audio (this should work on desktop with a click)
                audio.play().then(() => {
                    console.log("Audio played successfully via Play/Pause button.");
                }).catch(error => {
                    console.warn("Audio play failed on Play/Pause button click (desktop):", error);
                    // On desktop, we typically don't show a persistent prompt for this button
                });
                playPauseButton.textContent = 'Pause Animation & Audio';
            }
            isPlaying = !isPlaying;
        }

        // --- Initial Setup and Immediate AR Launch on Mobile / PC Message ---
        document.addEventListener('DOMContentLoaded', () => {
            if (isMobileDevice()) {
                arMessage.style.display = 'none'; // Hide generic PC message on mobile
                // Attempt to launch AR immediately on mobile.
                // This call itself might still require a user gesture on some browsers
                // to open the AR viewer (e.g., Chrome on Android's Scene Viewer app).
                modelViewer.activateAR();
            } else {
                // On PC, show the message and hide the AR button as it's not functional
                arMessage.style.display = 'block';
                arButton.style.display = 'none'; // Hide the AR button on desktop
            }

            // Set initial play/pause button state (for desktop/viewer mode)
            playPauseButton.textContent = 'Play Animation & Audio';
        });

        // --- Event Listeners for Model Viewer and Controls ---

        // Main Play/Pause button click
        playPauseButton.addEventListener('click', togglePlayPause);

        // Listen for model-viewer's internal play/pause events
        // These are primarily for updating the button's visual state,
        // not for toggling the `isPlaying` flag (that's the button's job).
        modelViewer.addEventListener('play', () => {
            // Only update if not in AR (where this button is hidden)
            if (!isARActive) {
                playPauseButton.textContent = 'Pause Animation & Audio';
            }
        });

        modelViewer.addEventListener('pause', () => {
            // Only update if not in AR (where this button is hidden)
            if (!isARActive) {
                playPauseButton.textContent = 'Play Animation & Audio';
            }
        });

        // --- AR Status Listener (Crucial for AR Audio/Animation Sync) ---
        modelViewer.addEventListener('ar-status', (event) => {
            if (event.detail.status === 'session-started') {
                console.log('AR session started! Attempting to play animation and audio.');
                isARActive = true;

                // Hide desktop-only message and main controls during AR session
                arMessage.style.display = 'none';
                playPauseButton.style.display = 'none';
                urlButton.style.display = 'block'; // URL button remains visible
                arButton.style.display = 'none'; // AR button is part of the session now
                audioInARPrompt.style.display = 'none'; // Ensure prompt is hidden initially

                // Immediately play animation
                if (modelViewer.animationName) {
                    modelViewer.play();
                    console.log(`Playing animation: ${modelViewer.animationName}`);
                } else {
                    console.warn("No animation-name specified or found. Cannot play animation in AR.");
                }

                // Attempt to play audio only if it hasn't successfully played in AR before
                if (!audioAlreadyPlayedInAR) {
                    audio.play().then(() => {
                        console.log("Audio played successfully in AR (autoplay success).");
                        audioInARPrompt.style.display = 'none'; // Hide if successful
                        audioAlreadyPlayedInAR = true; // Mark as played
                    }).catch(error => {
                        console.error("Audio autoplay failed in AR (user gesture needed):", error);
                        // Display the prompt if autoplay failed
                        audioInARPrompt.style.display = 'block';
                        // Make the prompt itself clickable to trigger audio
                        audioInARPrompt.onclick = () => {
                            audio.play().then(() => {
                                audioInARPrompt.style.display = 'none';
                                audioAlreadyPlayedInAR = true; // Mark as played
                                console.log("Audio played after user tap on prompt in AR.");
                            }).catch(err => {
                                console.error("Audio still failing after user tap on prompt in AR:", err);
                                // You might want a persistent "audio failed" message here if it still doesn't play
                            });
                        };
                    });
                } else {
                    // If audio has already been successfully played in AR, just play it again
                    audio.play().catch(error => {
                         console.warn("Audio play failed on re-entering AR (already played once):", error);
                         // This might happen if user navigated away and back without closing tab
                         // In this case, the prompt won't reappear due to audioAlreadyPlayedInAR
                    });
                }


            } else if (event.detail.status === 'session-ended') {
                console.log('AR session ended.');
                isARActive = false;

                // Show main controls again after AR session ends
                playPauseButton.style.display = 'block';
                urlButton.style.display = 'none'; // Hide URL button again
                arButton.style.display = 'block'; // Show AR button again

                modelViewer.pause(); // Pause animation when leaving AR
                audio.pause();       // Pause audio when leaving AR
                isPlaying = false; // Reset play state for desktop mode
                playPauseButton.textContent = 'Play Animation & Audio'; // Reset button text

                // Hide any lingering audio prompt
                audioInARPrompt.style.display = 'none';

                // If on PC, re-show the AR message
                if (!isMobileDevice()) {
                    arMessage.style.display = 'block';
                    arButton.style.display = 'none'; // Keep AR button hidden on desktop
                }

            } else if (event.detail.status === 'not-ar-capable') {
                // This status can occur on mobile if device truly isn't AR capable,
                // or on desktop if the model-viewer determines it.
                if (!isMobileDevice()) { // Only show message if definitely on PC
                    arMessage.style.display = 'block';
                    arButton.style.display = 'none'; // Hide AR button
                } else {
                     // On mobile but not AR capable - perhaps show a different message
                     console.warn("Mobile device is not AR capable.");
                     arMessage.textContent = "Your device is not AR capable. Viewing 3D model only.";
                     arMessage.style.display = 'block';
                     arButton.style.display = 'none';
                }
            }
            // For other ar-status like 'failed', 'error', etc., you might add more handling
        });

        // --- URL Button Logic ---
        urlButton.addEventListener('click', () => {
            const amazonUrl = "https://www.amazon.com/Sweet-Dreams-Sugarlump-childrens-everywhere/dp/B0FFZD7D12/ref=sr_1_1?crid=2PE5ZR31RUKFJ&dib=eyJ2IjoiMSJ9.eirXTPVo6volOV0M2LSzWYM7M7OETpDHtuB5kCsvMqZpHjvNE3fvrGYiQzi9OEE_KnGVoDwiK8TJUKsihTlWlEkYrzfe4QfSs8rE6vaoo0Y5BfWqKzpuFPGm7bKE9IC-Kz-0FvP462KBgxOa04D1aqfLppMInjk90QDppqNon6eTrQ0InDpeNmty3hB14QayZjes0oEcHGgvSH_4mtoM9SHyIbK9wzspljEyRdN_vAiF9SAFTutLx3FZqHy8JM44s5QDZ0XdYakBff_dMR3KMvFf10ZCsMFhMmGz6QY5jPI.EkEaYpKKTbUyJ3uJZG_vjHaGCtcX2MSHyN27dyNdIqY&dib_tag=se&keywords=sugarlump&qid=1752536576&sprefix=sugarlump%2Caps%2C158&sr=8-1'";
            window.open(amazonUrl, '_blank');
        });

    </script>
</body>
</html>

<!--<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sugarlump Amazon Book</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
  <style>
    #ar-button {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #url-button {
      display: none;
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <model-viewer 
    src="Models/kindness_rocks_large_7.glb?sound=Sound/Kindness Rocks_mix.mp3" 
    ios-src="KINDNESS_ROCKS_LARGE_7_Output.usdz"
    alt="A 3D model" 
    ar 
    ar-modes="scene-viewer webxr quick-look" 
    camera-controls 
    auto-rotate 
    autoplay 
    poster="images/rocks.png" 
    shadow-intensity="1" 
    ar-scale="auto" 
    ar-placement="floor"
    interaction-prompt="none">
    <button slot="ar-button" id="ar-button">View in your space</button>
  </model-viewer>

  <audio id="audio" src="Sound/Kindness Rocks_mix.mp3" loop></audio>
  <button id="play-audio" onclick="document.getElementById('audio').play()">Play Audio</button>

  <button id="url-button" onclick="window.location.href='https://www.amazon.com/Sweet-Dreams-Sugarlump-childrens-everywhere/dp/B0FFZD7D12/ref=sr_1_1?crid=2PE5ZR31RUKFJ&dib=eyJ2IjoiMSJ9.eirXTPVo6volOV0M2LSzWYM7M7OETpDHtuB5kCsvMqZpHjvNE3fvrGYiQzi9OEE_KnGVoDwiK8TJUKsihTlWlEkYrzfe4QfSs8rE6vaoo0Y5BfWqKzpuFPGm7bKE9IC-Kz-0FvP462KBgxOa04D1aqfLppMInjk90QDppqNon6eTrQ0InDpeNmty3hB14QayZjes0oEcHGgvSH_4mtoM9SHyIbK9wzspljEyRdN_vAiF9SAFTutLx3FZqHy8JM44s5QDZ0XdYakBff_dMR3KMvFf10ZCsMFhMmGz6QY5jPI.EkEaYpKKTbUyJ3uJZG_vjHaGCtcX2MSHyN27dyNdIqY&dib_tag=se&keywords=sugarlump&qid=1752536576&sprefix=sugarlump%2Caps%2C158&sr=8-1'">Go to Book</button>

  <script>
    const modelViewer = document.querySelector('model-viewer');
    modelViewer.addEventListener('ar-status', (event) => {
      if (event.detail.status === 'session-started') {
        document.getElementById('url-button').style.display = 'block';
      } else {
        document.getElementById('url-button').style.display = 'none';
      }
    });
  </script>
</body>
</html> -->

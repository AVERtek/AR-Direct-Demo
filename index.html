<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugarlump Amazon Book - Robust AR Audio & Animation Sync</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            position: relative;
            overflow: hidden;
        }
        model-viewer {
            width: 100%;
            height: 100vh;
            background-color: #ffffff;
        }

        /* Container for the main controls (Play/Pause, Go to Book) */
        .main-controls-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column; /* Changed to column for playbar */
            gap: 10px; /* Reduced gap for more compact controls */
            align-items: center; /* Center items horizontally */
            z-index: 10;
            width: 90%; /* Give it some width for the slider */
            max-width: 500px; /* Max width for larger screens */
        }

        /* Styling for all buttons */
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        /* Specific styles for each button type */
        .ar-button {
            background-color: #007bff; /* Blue for AR */
            color: white;
        }
        .ar-button:hover {
            background-color: #0056b3;
        }

        .play-pause-button {
            background-color: #6f42c1; /* Purple for Play/Pause */
            color: white;
            width: 100%; /* Make it fill the container */
        }
        .play-pause-button:hover {
            background-color: #5a2e9b;
        }

        .url-button {
            background-color: #28a745; /* Green for URL */
            color: white;
            width: 100%; /* Make it fill the container */
        }
        .url-button:hover {
            background-color: #218838;
        }

        /* Playback bar styles */
        .playback-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%; /* Fill the container width */
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .playback-controls input[type="range"] {
            flex-grow: 1; /* Take up available space */
            -webkit-appearance: none;
            height: 8px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 4px;
        }

        .playback-controls input[type="range"]:hover {
            opacity: 1;
        }

        .playback-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #6f42c1;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .playback-controls input[type="range"]::-webkit-slider-thumb:hover {
            background: #5a2e9b;
        }

        .time-display {
            font-size: 0.9em;
            color: #333;
            min-width: 70px; /* Ensure space for time display */
            text-align: center;
        }

        /* Message for PC users for AR - MOVED TO TOP */
        #ar-message {
            position: absolute;
            top: 0;
            left: 0;
            transform: none;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 0;
            border-radius: 0;
            text-align: center;
            font-size: 1.2em;
            z-index: 20;
            display: none;
            box-sizing: border-box;
        }

        /* Prompt for audio in AR if it doesn't autoplay */
        #audio-in-ar-prompt {
            position: absolute;
            top: 10%; /* Position near the top for visibility in AR */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 99, 71, 0.9); /* Tomato red */
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            text-align: center;
            font-size: 1em;
            z-index: 30; /* Above all other elements */
            display: none; /* Hidden by default */
            cursor: pointer; /* Indicate it's clickable */
            white-space: nowrap; /* Prevent text wrapping */
            animation: pulse 1.5s infinite; /* Added a subtle animation */
        }

        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) scale(1.03); opacity: 0.9; }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="ar-message">
        This AR experience requires a mobile device.<br>
        Please open this page on your smartphone or tablet.
        <br><br>
        (The 3D model will appear below, but AR features are mobile-only.)
    </div>

    <div id="audio-in-ar-prompt">
        Tap to Enable Sound
    </div>

    <model-viewer
        id="myModelViewer"
        src="Models/kindness_rocks_large_7.glb"
        ios-src="KINDNESS_ROCKS_LARGE_7_Output.usdz"
        alt="A 3D model"
        mode="ar_preferred"
        ar
        ar-modes="scene-viewer webxr quick-look"
        camera-controls
        poster="images/rocks.png"
        shadow-intensity="1"
        ar-scale="auto"
        ar-placement="floor"
        interaction-prompt="none"
        animation-name="Wave" autoplay="false" >
        <button slot="ar-button" id="ar-button" class="ar-button">Launch AR</button>
    </model-viewer>
    
    <audio id="audio" src="Sound/Kindness Rocks_mix.mp3" loop preload="auto"></audio>
    
    <div class="main-controls-container">
        <div class="playback-controls">
            <span id="currentTimeDisplay" class="time-display">0:00</span>
            <input type="range" id="animationSeeker" value="0" min="0" step="0.01">
            <span id="durationDisplay" class="time-display">0:00</span>
        </div>
        <button id="playPauseButton" class="play-pause-button">Play Animation & Audio</button>
        <button id="url-button" class="url-button">Go to Book</button>
    </div>

    <script>
        const modelViewer = document.getElementById('myModelViewer');
        const playPauseButton = document.getElementById('playPauseButton');
        const urlButton = document.getElementById('url-button');
        const audio = document.getElementById('audio');
        const arMessage = document.getElementById('ar-message');
        const arButton = document.getElementById('ar-button'); // Reference to the slotted AR button
        const audioInARPrompt = document.getElementById('audio-in-ar-prompt'); // Audio prompt for AR

        const animationSeeker = document.getElementById('animationSeeker');
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');
        const durationDisplay = document.getElementById('durationDisplay');

        let isPlaying = false; // Initial state for desktop animation/audio
        let isARActive = false; // Flag to track if AR session is active
        let audioPlayAttemptedInAR = false; // Tracks if we've tried to play audio in *this* AR session
        let animationDuration = 0;
        let audioDuration = 0;
        let isSeeking = false; // Flag to prevent time updates while dragging slider


        // --- Helper function to format time (e.g., 1:30) ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        // --- Device Detection (Simple) ---
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                    ('ontouchstart' in window && navigator.maxTouchPoints > 0);
        }

        // --- Unified Play/Pause Function for Model Animation and Audio (Desktop/Viewer Mode) ---
        function togglePlayPause() {
            if (isARActive) {
                console.log("Play/Pause button ignored, AR is active.");
                return;
            }

            if (isPlaying) {
                modelViewer.pause();
                audio.pause();
                playPauseButton.textContent = 'Play Animation & Audio';
            } else {
                if (modelViewer.animationName) {
                    modelViewer.play();
                } else {
                    console.warn("No animation-name specified or found on model. Cannot play animation.");
                }

                audio.play().then(() => {
                    console.log("Audio played successfully via Play/Pause button.");
                }).catch(error => {
                    console.warn("Audio play failed on Play/Pause button click (desktop):", error);
                    console.error("Audio Play Error:", error.name, error.message);
                });
                playPauseButton.textContent = 'Pause Animation & Audio';
            }
            isPlaying = !isPlaying;
        }

        // --- Event Listeners for Model Viewer and Controls ---

        // Get duration once model and audio are loaded
        modelViewer.addEventListener('load', () => {
            // Ensure animation name is set, otherwise default to first if available
            if (!modelViewer.animationName && modelViewer.availableAnimations.length > 0) {
                modelViewer.animationName = modelViewer.availableAnimations[0];
                console.log(`No animation-name set, using first available: ${modelViewer.animationName}`);
            }
            animationDuration = modelViewer.duration || 0; // Fallback to 0 if no animation
            console.log("Model animation duration:", animationDuration);
            updateDurationDisplay();
        });

        audio.addEventListener('loadedmetadata', () => {
            audioDuration = audio.duration;
            console.log("Audio duration:", audioDuration);
            updateDurationDisplay();
        });

        function updateDurationDisplay() {
            // Use the longer of the two durations, or a specific one if preferred for the timeline length
            const maxDuration = Math.max(animationDuration, audioDuration);
            animationSeeker.max = maxDuration;
            durationDisplay.textContent = formatTime(maxDuration);
        }

        // Update seeker and current time display as audio plays
        audio.addEventListener('timeupdate', () => {
            if (!isSeeking && isPlaying && !isARActive) {
                const currentTime = audio.currentTime;
                animationSeeker.value = currentTime;
                currentTimeDisplay.textContent = formatTime(currentTime);
                
                // Keep model in sync with audio
                if (modelViewer.currentTime !== currentTime) {
                    modelViewer.currentTime = currentTime;
                }
            }
        });

        // Handle seeking when user drags the slider
        animationSeeker.addEventListener('pointerdown', () => {
            isSeeking = true;
            if (isPlaying) {
                modelViewer.pause();
                audio.pause();
            }
        });

        animationSeeker.addEventListener('pointerup', () => {
            isSeeking = false;
            const seekTime = parseFloat(animationSeeker.value);
            modelViewer.currentTime = seekTime;
            audio.currentTime = seekTime;
            currentTimeDisplay.textContent = formatTime(seekTime);
            if (isPlaying) { // Resume playing if it was playing before seek
                modelViewer.play();
                audio.play().catch(e => console.warn("Audio play failed after seek:", e));
            }
        });

        animationSeeker.addEventListener('input', () => {
             // Update current time display as user drags
            currentTimeDisplay.textContent = formatTime(parseFloat(animationSeeker.value));
        });

        // When animation ends, pause both and reset states
        modelViewer.addEventListener('animation-ended', () => {
            if (!isARActive) {
                modelViewer.pause();
                audio.pause();
                isPlaying = false;
                playPauseButton.textContent = 'Play Animation & Audio';
                modelViewer.currentTime = 0; // Reset animation to start
                audio.currentTime = 0;       // Reset audio to start
                animationSeeker.value = 0;
                currentTimeDisplay.textContent = formatTime(0);
            }
        });

        playPauseButton.addEventListener('click', togglePlayPause);
        
        modelViewer.addEventListener('play', () => {
            if (!isARActive) {
                playPauseButton.textContent = 'Pause Animation & Audio';
                isPlaying = true; // Ensure isPlaying is true
            }
        });
        modelViewer.addEventListener('pause', () => {
            if (!isARActive) {
                playPauseButton.textContent = 'Play Animation & Audio';
                isPlaying = false; // Ensure isPlaying is false
            }
        });


        // --- Initial Setup and Immediate AR Launch on Mobile / PC Message ---
        document.addEventListener('DOMContentLoaded', () => {
            if (isMobileDevice()) {
                arMessage.style.display = 'none';
                modelViewer.activateAR(); // Attempt immediate AR launch
            } else {
                arMessage.style.display = 'block';
                arButton.style.display = 'none'; // Hide the AR button on non-AR-capable devices
            }
            playPauseButton.textContent = 'Play Animation & Audio'; // Initial text
        });

        // --- AR Status Listener (Crucial for AR Audio/Animation Sync) ---
        modelViewer.addEventListener('ar-status', (event) => {
            console.log('AR Status Event:', event.detail.status); // Log all AR status changes

            if (event.detail.status === 'session-started') {
                console.log('AR session started! Attempting to play animation and audio.');
                isARActive = true;
                audioPlayAttemptedInAR = false; // Reset for a new AR session

                // Hide general messages and desktop controls
                arMessage.style.display = 'none';
                playPauseButton.style.display = 'none';
                document.querySelector('.playback-controls').style.display = 'none'; // Hide playbar
                urlButton.style.display = 'block'; // Keep URL button visible
                arButton.style.display = 'none'; // Hide the slotted AR button when AR is active

                // Always try to play animation
                if (modelViewer.animationName) {
                    modelViewer.play({ repetition: "infinite" }); // Ensure animation loops in AR
                    console.log(`Playing animation: ${modelViewer.animationName}`);
                } else {
                    console.warn("No animation-name specified or found. Cannot play animation in AR.");
                }

                // Attempt to play audio on AR session start
                audio.currentTime = 0; // Set current time to 0 to ensure it restarts if it was previously paused
                audio.muted = false; // Explicitly ensure it's not muted
                audio.play().then(() => {
                    console.log("Audio played successfully in AR (autoplay success).");
                    audioInARPrompt.style.display = 'none'; // Hide if successful
                    audioPlayAttemptedInAR = true;
                }).catch(error => {
                    console.error("Audio autoplay failed in AR (user gesture needed):", error);
                    console.error("Audio Play Error Details:", error.name, error.message);
                    
                    // If autoplay fails, show the prompt, but only if we haven't already tried
                    if (!audioPlayAttemptedInAR) { // Check this *again*
                        audioInARPrompt.style.display = 'block';
                        console.log("Displaying 'Tap to Enable Sound' prompt.");
                        audioPlayAttemptedInAR = true; // Mark that we've tried and now showing prompt
                    }
                });

                // Define the prompt's click handler *within* this block to ensure it's
                // always ready when the prompt is shown in AR.
                audioInARPrompt.onclick = () => {
                    console.log("Audio prompt tapped. Attempting to play audio...");
                    audio.currentTime = 0; // Reset just in case
                    audio.muted = false;    // Ensure not muted by default
                    audio.play().then(() => {
                        audioInARPrompt.style.display = 'none';
                        console.log("Audio played successfully after user tap on prompt.");
                    }).catch(err => {
                        console.error("Audio still failing after user tap on prompt in AR:", err);
                        console.error("Audio Play Error Details (Tap):", err.name, err.message);
                        // At this point, the audio genuinely cannot be played by the browser.
                        audioInARPrompt.textContent = "Sound Unavailable"; // Change message
                        audioInARPrompt.style.backgroundColor = "gray"; // Indicate failure
                        audioInARPrompt.onclick = null; // Remove further click handler
                    });
                };

            } else if (event.detail.status === 'session-ended') {
                console.log('AR session ended.');
                isARActive = false;

                // Restore desktop controls and messages
                playPauseButton.style.display = 'block';
                document.querySelector('.playback-controls').style.display = 'flex'; // Show playbar
                urlButton.style.display = 'none'; // Hide URL button
                arButton.style.display = 'block'; // Show the slotted AR button

                modelViewer.pause();
                audio.pause();
                isPlaying = false;
                playPauseButton.textContent = 'Play Animation & Audio';
                modelViewer.currentTime = 0; // Reset animation to start
                audio.currentTime = 0;       // Reset audio to start
                animationSeeker.value = 0;
                currentTimeDisplay.textContent = formatTime(0);

                audioInARPrompt.style.display = 'none'; // Hide AR audio prompt
                audioPlayAttemptedInAR = false; // Reset for next AR session

                if (!isMobileDevice()) {
                    arMessage.style.display = 'block';
                    arButton.style.display = 'none'; // Hide the AR button on non-AR-capable devices
                }

            } else if (event.detail.status === 'not-ar-capable') {
                if (!isMobileDevice()) {
                    arMessage.style.display = 'block';
                    arButton.style.display = 'none';
                } else {
                    console.warn("Mobile device is not AR capable.");
                    arMessage.textContent = "Your device is not AR capable. Viewing 3D model only.";
                    arMessage.style.display = 'block';
                    arButton.style.display = 'none';
                }
                // Ensure 3D mode controls are visible if AR is not capable
                playPauseButton.style.display = 'block';
                document.querySelector('.playback-controls').style.display = 'flex';
                urlButton.style.display = 'none';
            }
        });

        // --- URL Button Logic ---
        urlButton.addEventListener('click', () => {
            const amazonUrl = "https://www.amazon.com/Sweet-Dreams-Sugarlump-childrens-everywhere/dp/B0FFZD7D12/ref=sr_1_1?crid=2PE5ZR31RUKFJ&dib=eyJ2IjoiMSJ9.eirXTPVo6volOV0M2LSzWYM7M7OETpDHtuB5kCsvMqZpHjvNE3fvrGYiQzi9OEE_KnGVoDwiK8TJUKsihTlWlEkYrzfe4QfSs8rE6vaoo0Y5BfWqKzpuFPGm7bKE9IC-Kz-0FvP462KBgxOa04D1aqfLppMInjk90QDppTNon6eTrQ0InDpeNmty3hB14QayZjes0oEcHGgvSH_4m4oM9SHyIbK9wzspljEyRdN_vAiF9SAFTutLx3FZqHy8JM44s5QDZ0XdYakBff_dMR3KMvFf10ZCsMFhMmGz6QY5jPI.EkEaYpKKTbUyJ3uJZG_vjHaGCtcX2MSHyN27dyNdIqY&dib_tag=se&keywords=sugarlump&qid=1752536576&sprefix=sugarlump%2Caps%2C158&sr=8-1'";
            window.open(amazonUrl, '_blank');
        });
    </script>
</body>
</html>

<!--<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sugarlump Amazon Book - Robust AR Audio & Animation Sync</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            position: relative;
            overflow: hidden;
        }
        model-viewer {
            width: 100%;
            height: 100vh;
            background-color: #ffffff;
        }

        /* Container for the main controls (Play/Pause, Go to Book) */
        .main-controls-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 10;
        }

        /* Styling for all buttons */
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        /* Specific styles for each button type */
        .ar-button {
            background-color: #007bff; /* Blue for AR */
            color: white;
        }
        .ar-button:hover {
            background-color: #0056b3;
        }

        .play-pause-button {
            background-color: #6f42c1; /* Purple for Play/Pause */
            color: white;
        }
        .play-pause-button:hover {
            background-color: #5a2e9b;
        }

        .url-button {
            background-color: #28a745; /* Green for URL */
            color: white;
        }
        .url-button:hover {
            background-color: #218838;
        }

        /* Message for PC users for AR - MOVED TO TOP */
        #ar-message {
            position: absolute;
            top: 0;
            left: 0;
            transform: none;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 0;
            border-radius: 0;
            text-align: center;
            font-size: 1.2em;
            z-index: 20;
            display: none;
            box-sizing: border-box;
        }

        /* Prompt for audio in AR if it doesn't autoplay */
        #audio-in-ar-prompt {
            position: absolute;
            top: 10%; /* Position near the top for visibility in AR */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 99, 71, 0.9); /* Tomato red */
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            text-align: center;
            font-size: 1em;
            z-index: 30; /* Above all other elements */
            display: none; /* Hidden by default */
            cursor: pointer; /* Indicate it's clickable */
            white-space: nowrap; /* Prevent text wrapping */
            animation: pulse 1.5s infinite; /* Added a subtle animation */
        }

        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); opacity: 1; }
            50% { transform: translateX(-50%) scale(1.03); opacity: 0.9; }
            100% { transform: translateX(-50%) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="ar-message">
        This AR experience requires a mobile device.<br>
        Please open this page on your smartphone or tablet.
        <br><br>
        (The 3D model will appear below, but AR features are mobile-only.)
    </div>

    <div id="audio-in-ar-prompt">
        Tap to Enable Sound
    </div>

    <model-viewer
        id="myModelViewer"
        src="Models/kindness_rocks_large_7.glb?sound=Sound/Kindness Rocks_mix.mp3"
        ios-src="KINDNESS_ROCKS_LARGE_7_Output.usdz"
        alt="A 3D model"
        mode="ar_preferred"
        ar
        ar-modes="scene-viewer webxr quick-look"
        camera-controls
        poster="images/rocks.png"
        shadow-intensity="1"
        ar-scale="auto"
        ar-placement="floor"
        interaction-prompt="none"
        animation-name="Wave" autoplay="false" >
        <button slot="ar-button" id="ar-button" class="ar-button">Launch AR</button>
    </model-viewer> 
    
    <audio id="audio" src="Sound/Kindness Rocks_mix.mp3" loop preload="auto"></audio> <div class="main-controls-container">
        <button id="playPauseButton" class="play-pause-button">Play Animation & Audio</button>
        <button id="url-button" class="url-button">Go to Book</button>
    </div>

    <script>
        window.addEventListener("load", () => {
        var modelViewer = document.querySelector('model-viewer');
        console.log("Can activate AR: " + modelViewer.canActivateAR);
        modelViewer.activateAR();
        });
    </script>
    
    <script>
        const modelViewer = document.getElementById('myModelViewer');
        const playPauseButton = document.getElementById('playPauseButton');
        const urlButton = document.getElementById('url-button');
        const audio = document.getElementById('audio');
        const arMessage = document.getElementById('ar-message');
        const arButton = document.getElementById('ar-button'); // Reference to the slotted AR button
        const audioInARPrompt = document.getElementById('audio-in-ar-prompt'); // Audio prompt for AR

        let isPlaying = false; // Initial state for desktop animation/audio
        let isARActive = false; // Flag to track if AR session is active
        let audioPlayAttemptedInAR = false; // Tracks if we've tried to play audio in *this* AR session

        // --- Device Detection (Simple) ---
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   ('ontouchstart' in window && navigator.maxTouchPoints > 0);
        }

        // --- Unified Play/Pause Function for Model Animation and Audio (Desktop/Viewer Mode) ---
        function togglePlayPause() {
            if (isARActive) {
                console.log("Play/Pause button ignored, AR is active.");
                return;
            }

            if (isPlaying) {
                modelViewer.pause();
                audio.pause();
                playPauseButton.textContent = 'Play Animation & Audio';
            } else {
                if (modelViewer.animationName) {
                    modelViewer.play();
                } else {
                    console.warn("No animation-name specified or found on model. Cannot play animation.");
                }

                audio.play().then(() => {
                    console.log("Audio played successfully via Play/Pause button.");
                }).catch(error => {
                    console.warn("Audio play failed on Play/Pause button click (desktop):", error);
                    console.error("Audio Play Error:", error.name, error.message);
                });
                playPauseButton.textContent = 'Pause Animation & Audio';
            }
            isPlaying = !isPlaying;
        }

        // --- Initial Setup and Immediate AR Launch on Mobile / PC Message ---
        document.addEventListener('DOMContentLoaded', () => {
            if (isMobileDevice()) {
                arMessage.style.display = 'none';
                modelViewer.activateAR(); // Attempt immediate AR launch
            } else {
                arMessage.style.display = 'block';
                arButton.style.display = 'none';
            }
            playPauseButton.textContent = 'Play Animation & Audio';
        });

        // --- Event Listeners for Model Viewer and Controls ---
        playPauseButton.addEventListener('click', togglePlayPause);
        modelViewer.addEventListener('play', () => {
            if (!isARActive) {
                playPauseButton.textContent = 'Pause Animation & Audio';
            }
        });
        modelViewer.addEventListener('pause', () => {
            if (!isARActive) {
                playPauseButton.textContent = 'Play Animation & Audio';
            }
        });

        // --- AR Status Listener (Crucial for AR Audio/Animation Sync) ---
        modelViewer.addEventListener('ar-status', (event) => {
            console.log('AR Status Event:', event.detail.status); // Log all AR status changes

            if (event.detail.status === 'session-started') {
                console.log('AR session started! Attempting to play animation and audio.');
                isARActive = true;
                audioPlayAttemptedInAR = false; // Reset for a new AR session

                // Hide general messages and desktop controls
                arMessage.style.display = 'none';
                playPauseButton.style.display = 'none';
                urlButton.style.display = 'block'; // Keep URL button visible
                arButton.style.display = 'none';

                // Always try to play animation
                if (modelViewer.animationName) {
                    modelViewer.play();
                    console.log(`Playing animation: ${modelViewer.animationName}`);
                } else {
                    console.warn("No animation-name specified or found. Cannot play animation in AR.");
                }

                // Attempt to play audio on AR session start
                // Set current time to 0 to ensure it restarts if it was previously paused
                audio.currentTime = 0;
                audio.muted = false; // Explicitly ensure it's not muted
                audio.play().then(() => {
                    console.log("Audio played successfully in AR (autoplay success).");
                    audioInARPrompt.style.display = 'none'; // Hide if successful
                    audioPlayAttemptedInAR = true;
                }).catch(error => {
                    console.error("Audio autoplay failed in AR (user gesture needed):", error);
                    console.error("Audio Play Error Details:", error.name, error.message);
                    
                    // If autoplay fails, show the prompt, but only if we haven't already tried
                    if (!audioPlayAttemptedInAR) { // Check this *again*
                        audioInARPrompt.style.display = 'block';
                        console.log("Displaying 'Tap to Enable Sound' prompt.");
                        audioPlayAttemptedInAR = true; // Mark that we've tried and now showing prompt
                    }
                });

                // Define the prompt's click handler *within* this block to ensure it's
                // always ready when the prompt is shown in AR.
                audioInARPrompt.onclick = () => {
                    console.log("Audio prompt tapped. Attempting to play audio...");
                    audio.currentTime = 0; // Reset just in case
                    audio.muted = false;   // Ensure not muted by default
                    audio.play().then(() => {
                        audioInARPrompt.style.display = 'none';
                        console.log("Audio played successfully after user tap on prompt.");
                    }).catch(err => {
                        console.error("Audio still failing after user tap on prompt in AR:", err);
                        console.error("Audio Play Error Details (Tap):", err.name, err.message);
                        // At this point, the audio genuinely cannot be played by the browser.
                        // This might indicate a problem with the audio file itself or browser permissions.
                        audioInARPrompt.textContent = "Sound Unavailable"; // Change message
                        audioInARPrompt.style.backgroundColor = "gray"; // Indicate failure
                        audioInARPrompt.onclick = null; // Remove further click handler
                    });
                };

            } else if (event.detail.status === 'session-ended') {
                console.log('AR session ended.');
                isARActive = false;

                // Restore desktop controls and messages
                playPauseButton.style.display = 'block';
                urlButton.style.display = 'none';
                arButton.style.display = 'block';

                modelViewer.pause();
                audio.pause();
                isPlaying = false;
                playPauseButton.textContent = 'Play Animation & Audio';

                audioInARPrompt.style.display = 'none'; // Hide AR audio prompt
                audioPlayAttemptedInAR = false; // Reset for next AR session

                if (!isMobileDevice()) {
                    arMessage.style.display = 'block';
                    arButton.style.display = 'none';
                }

            } else if (event.detail.status === 'not-ar-capable') {
                if (!isMobileDevice()) {
                    arMessage.style.display = 'block';
                    arButton.style.display = 'none';
                } else {
                    console.warn("Mobile device is not AR capable.");
                    arMessage.textContent = "Your device is not AR capable. Viewing 3D model only.";
                    arMessage.style.display = 'block';
                    arButton.style.display = 'none';
                }
            }
        });

        // --- URL Button Logic ---
        urlButton.addEventListener('click', () => {
            const amazonUrl = "https://www.amazon.com/Sweet-Dreams-Sugarlump-childrens-everywhere/dp/B0FFZD7D12/ref=sr_1_1?crid=2PE5ZR31RUKFJ&dib=eyJ2IjoiMSJ9.eirXTPVo6volOV0M2LSzWYM7M7OETpDHtuB5kCsvMqZpHjvNE3fvrGYiQzi9OEE_KnGVoDwiK8TJUKsihTlWlEkYrzfe4QfSs8rE6vaoo0Y5BfWqKzpuFPGm7bKE9IC-Kz-0FvP462KBgxOa04D1aqfLppMInjk90QDppqNon6eTrQ0InDpeNmty3hB14QayZjes0oEcHGgvSH_4m4oM9SHyIbK9wzspljEyRdN_vAiF9SAFTutLx3FZqHy8JM44s5QDZ0XdYakBff_dMR3KMvFf10ZCsMFhMmGz6QY5jPI.EkEaYpKKTbUyJ3uJZG_vjHaGCtcX2MSHyN27dyNdIqY&dib_tag=se&keywords=sugarlump&qid=1752536576&sprefix=sugarlump%2Caps%2C158&sr=8-1'";
            window.open(amazonUrl, '_blank');
        });

    </script>
</body>
</html> -->

<!--<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>sugarlump Amazon Book</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script nomodule src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js"></script>
  <style>
    #ar-button {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #url-button {
      display: none;
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <model-viewer 
    src="Models/kindness_rocks_large_7.glb?sound=Sound/Kindness Rocks_mix.mp3" 
    ios-src="KINDNESS_ROCKS_LARGE_7_Output.usdz"
    alt="A 3D model" 
    ar 
    ar-modes="scene-viewer webxr quick-look" 
    camera-controls 
    auto-rotate 
    autoplay 
    poster="images/rocks.png" 
    shadow-intensity="1" 
    ar-scale="auto" 
    ar-placement="floor"
    interaction-prompt="none">
    <button slot="ar-button" id="ar-button">View in your space</button>
  </model-viewer>

  <audio id="audio" src="Sound/Kindness Rocks_mix.mp3" loop></audio>
  <button id="play-audio" onclick="document.getElementById('audio').play()">Play Audio</button>

  <button id="url-button" onclick="window.location.href='https://www.amazon.com/Sweet-Dreams-Sugarlump-childrens-everywhere/dp/B0FFZD7D12/ref=sr_1_1?crid=2PE5ZR31RUKFJ&dib=eyJ2IjoiMSJ9.eirXTPVo6volOV0M2LSzWYM7M7OETpDHtuB5kCsvMqZpHjvNE3fvrGYiQzi9OEE_KnGVoDwiK8TJUKsihTlWlEkYrzfe4QfSs8rE6vaoo0Y5BfWqKzpuFPGm7bKE9IC-Kz-0FvP462KBgxOa04D1aqfLppMInjk90QDppqNon6eTrQ0InDpeNmty3hB14QayZjes0oEcHGgvSH_4mtoM9SHyIbK9wzspljEyRdN_vAiF9SAFTutLx3FZqHy8JM44s5QDZ0XdYakBff_dMR3KMvFf10ZCsMFhMmGz6QY5jPI.EkEaYpKKTbUyJ3uJZG_vjHaGCtcX2MSHyN27dyNdIqY&dib_tag=se&keywords=sugarlump&qid=1752536576&sprefix=sugarlump%2Caps%2C158&sr=8-1'">Go to Book</button>

  <script>
    const modelViewer = document.querySelector('model-viewer');
    modelViewer.addEventListener('ar-status', (event) => {
      if (event.detail.status === 'session-started') {
        document.getElementById('url-button').style.display = 'block';
      } else {
        document.getElementById('url-button').style.display = 'none';
      }
    });
  </script>
</body>
</html> -->
